name: Deploy to Cloudflare Workers

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Preview ë°°í¬ (PR)
      - name: Deploy Preview
        if: github.event.pull_request.state == 'opened'
        run: |
          pnpm install --frozen-lockfile
          pnpm run preview -- --name unibusk-preview-${{ github.event.pull_request.number }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      # Production ë°°í¬ (PR Merge)
      - name: Deploy Production
        if: github.event.pull_request.merged == true
        run: |
          pnpm install --frozen-lockfile
          pnpm run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      # ë°°í¬ ê²°ê³¼ ìš”ì•½
      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.pull_request.state }}" == "opened" ]; then
            echo "| Preview | ${{ job.status }} | https://unibusk-preview-${{ github.event.pull_request.number }}.workers.dev |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            echo "| Production | ${{ job.status }} | https://unibusk.workers.dev |" >> $GITHUB_STEP_SUMMARY
          fi